# ESPHOME_SBER_SBDV-00115
Инструкция по прошивке лампы от Сбер девайсы SBDV-00115 в ESPHOME-LibreTiny.

Ранее Сбер продавал лампы, которые легко прошивались в EspHome-LibreTiny, просто потому, что они были чистокровная Tuya, например SBDV-00019). Теперь же, сбер делает новую версию ламп. Эти "новые" имеют меньше цветных диодов, а значить в цветном режиме светят слабее. Они СОВСЕМ не Туя, значит их по воздуху не прошить. И самое неприятное - в их прошивке задействовали шифрование и использован нестандартный загрузчик. 
В общем это руководство для тех кто купил эти лампы и хочет использовать их в Home Assistant.

Прошивка. 

Берем файл прошивки из данного репозитария. Это откомпилированная прошивка, правильно зашифрованная с подмененным загрузчикoм (OpenBK7231N_QIO_Sber_Fck.bin). Она прошьется в модуль сберлампы, без ошибки контрольной суммы и позволит дальше шить лампу из EspHome-LibreTiny.

Основной инструмент - https://github.com/openshwprojects/BK7231GUIFlashTool/releases/download/v1.1.0/bk7231flasher_1.1.0b.zip (утилита из проекта https://github.com/openshwprojects/BK7231GUIFlashTool )

Качаем, разархивируем, запускаем. Хочу заметить, что это единственный инструмент, который успешно шьет такие шифрованные модули.

Предполагается, что модуль уже снят с платы лампы и подключен к UART.

![1](https://github.com/Brokly/ESPHOME_SBER_SBDV-00115/assets/11642286/038dcfdd-28ec-47f7-a28a-43707a03ec44)

- В списке 0 выбираем порт, который отождествлен с нашим UART.

- Нажимаем кнопочку 1 и в открывшееся окно скачиваем прошивку (https://github.com/Brokly/ESPHOME_SBER_SBDV-00115/blob/main/OpenBK7231N_QIO_Sber_Fck.bin).

- Устанавливаем галочку 2.  

![2](https://github.com/Brokly/ESPHOME_SBER_SBDV-00115/assets/11642286/4455d89b-a3e1-454d-8c4f-064be06d1f9f)

- Устанавливаем галочку 3.

- В списке 4 выбираем BK7231N.

- В списке 5 выбираем скачанную стартовую прошивку - OpenBK7231N_QIO_Sber_Fck.bin.

- Нажимаем любую из кнопок 6, какую именно, решать вам, может захотите сохранить сберовский бэкап и потом восстановить лампу в заводскую прошивку.

- При необходимости, замыкаем контакт CEN на землю или кратковременно передергиваем питание модуля

- Ждем окончания прошивки.

- Жмакаем кнопку 7, со всем соглашаемся (это рандомизация MAC адреса, новая прошивка затрет бывший адрес).

После этих операций вы можете прошить свою конфигурацию по UART или OTA, естественно, создав конфигурацию с использованием EspHome-LibreTiny. Прошитый модуль создает точку доступа HalloSber. Можно подключиться к этой точке доступа, зайти на 192.168.4.1 и залить прошивку firmware.bin, созданную заранее. Обратите внимание, что в конфигурацию следует добавит следующие настройки:

esphome:

  platformio_options:
  
    board_build.bkcrypt_coeffs: 79bffed7a3fbeafd5dd3abffdfbfff5b
    
    board_build.bkota.key: BDB4CE110F4787C2F539BF50E30A14E0
    
    board_build.bkota.iv: 46DE464946314329
    
    board_flash.download: "0x132000+0x9E000"
    

Хочу отметить, что тут я не описываю разборку лампы, снятие модуля CB2L c платы лампы, распайку модуля для перепрошивки и прочие нюансы работы с модулями Tuya. 

Огромная благодарность автору форка EspHome-LibreTiny Кубе ( https://github.com/kuba2k2 ) за терпение и неоценимую помощь !
